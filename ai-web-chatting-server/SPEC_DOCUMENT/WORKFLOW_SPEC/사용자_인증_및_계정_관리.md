# 사용자 인증 및 계정 관리

## 개요

사용자 인증 및 계정 관리 워크플로우는 사용자의 전체 생명주기를 관리하는 핵심 비즈니스 프로세스입니다. 회원가입부터 시작하여 로그인, 토큰 갱신, 프로필 관리, 계정 삭제까지의 모든 사용자 관련 기능을 포함하며, JWT 기반의 토큰 화이트리스트 인증 시스템을 통해 보안성을 보장합니다.

## 상세 설명

### 주요 기능
- **회원가입**: 이메일, 이름, 비밀번호를 통한 신규 사용자 등록
- **로그인**: 이메일/비밀번호 인증 및 JWT 토큰 발급
- **토큰 갱신**: Refresh Token을 통한 Access Token 갱신
- **사용자 정보 조회**: 인증된 사용자의 프로필 정보 조회
- **프로필 수정**: 사용자 이름, 프로필 이미지 등 정보 업데이트
- **로그아웃**: 토큰 무효화를 통한 안전한 로그아웃
- **계정 삭제**: 사용자 계정 및 관련 데이터 영구 삭제

### 보안 특징
- **JWT 토큰 화이트리스트**: 발급된 토큰을 DB에 저장하여 유효성 검증
- **이중 토큰 시스템**: Access Token(1시간) + Refresh Token(5시간)
- **비밀번호 암호화**: bcrypt 기반 해시 암호화
- **토큰 자동 정리**: 만료된 토큰 자동 삭제 (6시간 주기)
- **입력 데이터 검증**: 미들웨어를 통한 데이터 유효성 검사

### 데이터베이스 스키마
- **User 테이블**: 사용자 기본 정보 (id, email, password, name, profileImage, isActive)
- **Token 테이블**: JWT 토큰 화이트리스트 (accessToken, refreshToken, expiresAt, isActive)

## Flow

### 플로우 차트

```mermaid
flowchart TD
    A[사용자 요청] --> B{요청 유형}
    
    B -->|회원가입| C[POST /users/signup]
    B -->|로그인| D[POST /users/login]
    B -->|토큰 갱신| E[POST /users/refresh]
    B -->|사용자 정보 조회| F[GET /users/me]
    B -->|프로필 수정| G[PUT /users/profile]
    B -->|로그아웃| H[POST /users/logout]
    B -->|계정 삭제| I[DELETE /users/account]
    
    C --> C1[validateSignup 미들웨어]
    C1 --> C2{검증 성공?}
    C2 -->|실패| C3[400/409 에러 응답]
    C2 -->|성공| C4[MySQLDatabaseService.createUser]
    C4 --> C5[비밀번호 해시화]
    C5 --> C6[사용자 생성]
    C6 --> C7[201 생성 완료]
    
    D --> D1[validateLogin 미들웨어]
    D1 --> D2{검증 성공?}
    D2 -->|실패| D3[400 에러 응답]
    D2 -->|성공| D4[MySQLDatabaseService.getUserByEmail]
    D4 --> D5{사용자 존재?}
    D5 -->|없음| D6[401 인증 실패]
    D5 -->|있음| D7[비밀번호 검증]
    D7 --> D8{비밀번호 일치?}
    D8 -->|불일치| D6
    D8 -->|일치| D9[JWT 토큰 쌍 생성]
    D9 --> D10[Token 테이블에 저장]
    D10 --> D11[lastLoginAt 업데이트]
    D11 --> D12[200 로그인 성공]
    
    E --> E1{Refresh Token 존재?}
    E1 -->|없음| E2[401 토큰 에러]
    E1 -->|있음| E3[Token 화이트리스트 확인]
    E3 --> E4{유효한 토큰?}
    E4 -->|무효| E2
    E4 -->|유효| E5[기존 토큰 무효화]
    E5 --> E6[새 토큰 쌍 생성]
    E6 --> E7[새 토큰 저장]
    E7 --> E8[200 갱신 완료]
    
    F --> F1[authenticateToken 미들웨어]
    F1 --> F2{토큰 유효?}
    F2 -->|무효| F3[401 인증 에러]
    F2 -->|유효| F4[MySQLDatabaseService.getUserById]
    F4 --> F5{사용자 존재?}
    F5 -->|없음| F6[404 사용자 없음]
    F5 -->|있음| F7[200 사용자 정보 반환]
    
    G --> G1[authenticateToken 미들웨어]
    G1 --> G2{토큰 유효?}
    G2 -->|무효| G3[401 인증 에러]
    G2 -->|유효| G4[validateUserUpdate 미들웨어]
    G4 --> G5{데이터 유효?}
    G5 -->|무효| G6[400 검증 에러]
    G5 -->|유효| G7[MySQLDatabaseService.updateUser]
    G7 --> G8[200 수정 완료]
    
    H --> H1[authenticateToken 미들웨어]
    H1 --> H2{토큰 유효?}
    H2 -->|무효| H3[401 인증 에러]
    H2 -->|유효| H4[MySQLDatabaseService.invalidateToken]
    H4 --> H5[200 로그아웃 완료]
    
    I --> I1[authenticateToken 미들웨어]
    I1 --> I2{토큰 유효?}
    I2 -->|무효| I3[401 인증 에러]
    I2 -->|유효| I4[MySQLDatabaseService.deleteUser]
    I4 --> I5{삭제 성공?}
    I5 -->|실패| I6[500 삭제 에러]
    I5 -->|성공| I7[200 탈퇴 완료]
```

### 시퀀스 다이어그램

#### 1. 회원가입 및 로그인 시퀀스

```mermaid
sequenceDiagram
    participant Client as 클라이언트
    participant API as API 서버
    participant Validator as 검증 미들웨어
    participant DB as MySQL 데이터베이스
    participant JWT as JWT 유틸리티
    
    Note over Client, JWT: 회원가입 프로세스
    Client->>API: POST /users/signup
    API->>Validator: validateSignup
    Validator->>DB: getUserByEmail (중복 체크)
    DB-->>Validator: 사용자 존재 여부
    alt 이메일 중복
        Validator-->>Client: 409 이메일 중복 에러
    else 검증 성공
        Validator->>API: 검증된 데이터 전달
        API->>DB: createUser (비밀번호 해시)
        DB-->>API: 생성된 사용자 정보
        API-->>Client: 201 회원가입 완료
    end
    
    Note over Client, JWT: 로그인 프로세스
    Client->>API: POST /users/login
    API->>Validator: validateLogin
    Validator->>API: 검증된 데이터 전달
    API->>DB: getUserByEmail
    DB-->>API: 사용자 정보
    alt 사용자 없거나 비밀번호 불일치
        API-->>Client: 401 인증 실패
    else 인증 성공
        API->>JWT: generateTokenPair
        JWT-->>API: Access/Refresh Token
        API->>DB: createToken (토큰 저장)
        API->>DB: updateUser (lastLoginAt)
        API-->>Client: 200 로그인 성공 + 토큰들
    end
```

#### 2. 토큰 갱신 및 인증 시퀀스

```mermaid
sequenceDiagram
    participant Client as 클라이언트
    participant API as API 서버
    participant Auth as 인증 미들웨어
    participant DB as MySQL 데이터베이스
    participant JWT as JWT 유틸리티
    
    Note over Client, JWT: 토큰 갱신 프로세스
    Client->>API: POST /users/refresh + Refresh Token
    API->>DB: findActiveRefreshToken
    DB-->>API: 토큰 레코드
    alt 토큰 무효
        API-->>Client: 401 토큰 에러
    else 토큰 유효
        API->>JWT: refreshAccessToken
        JWT-->>API: 새 토큰 쌍
        API->>DB: invalidateToken (기존 토큰)
        API->>DB: createToken (새 토큰)
        API-->>Client: 200 토큰 갱신 완료
    end
    
    Note over Client, JWT: 인증이 필요한 API 호출
    Client->>API: GET /users/me + Access Token
    API->>Auth: authenticateToken
    Auth->>JWT: verifyAccessToken
    JWT-->>Auth: 토큰 검증 결과
    Auth->>DB: findActiveToken (화이트리스트 확인)
    DB-->>Auth: 토큰 존재 여부
    alt 토큰 무효
        Auth-->>Client: 401 인증 에러
    else 토큰 유효
        Auth->>API: 인증된 사용자 정보 전달
        API->>DB: getUserById
        DB-->>API: 사용자 정보
        API-->>Client: 200 사용자 정보
    end
```

#### 3. 프로필 관리 및 계정 삭제 시퀀스

```mermaid
sequenceDiagram
    participant Client as 클라이언트
    participant API as API 서버
    participant Auth as 인증 미들웨어
    participant Validator as 검증 미들웨어
    participant DB as MySQL 데이터베이스
    
    Note over Client, DB: 프로필 수정 프로세스
    Client->>API: PUT /users/profile + Access Token
    API->>Auth: authenticateToken
    Auth-->>API: 인증 성공
    API->>Validator: validateUserUpdate
    Validator-->>API: 검증된 데이터
    API->>DB: updateUser
    DB-->>API: 수정된 사용자 정보
    API-->>Client: 200 프로필 수정 완료
    
    Note over Client, DB: 로그아웃 프로세스
    Client->>API: POST /users/logout + Access Token
    API->>Auth: authenticateToken
    Auth-->>API: 인증 성공 + tokenId
    API->>DB: invalidateToken
    DB-->>API: 토큰 무효화 완료
    API-->>Client: 200 로그아웃 완료
    
    Note over Client, DB: 계정 삭제 프로세스
    Client->>API: DELETE /users/account + Access Token
    API->>Auth: authenticateToken
    Auth-->>API: 인증 성공
    API->>DB: deleteUser (CASCADE로 관련 데이터 삭제)
    DB-->>API: 삭제 결과
    alt 삭제 실패
        API-->>Client: 500 삭제 에러
    else 삭제 성공
        API-->>Client: 200 계정 삭제 완료
    end
```

### 상세 처리 흐름 설명

#### 1. 회원가입 처리 흐름 (POST /users/signup)
1. 클라이언트에서 이메일, 이름, 비밀번호 전송
2. `validateSignup` 미들웨어에서 데이터 검증
   - 필수 필드 확인
   - 이메일 형식 검증 (정규식)
   - 이름 길이 검증 (2-50자)
   - 비밀번호 길이 검증 (6자 이상)
   - 비밀번호 강도 검증 (8자 이상일 경우)
   - 이메일 중복 확인 (DB 조회)
3. 검증 성공 시 `MySQLDatabaseService.createUser` 호출
4. 비밀번호 해시화 후 사용자 생성
5. 201 상태 코드와 함께 생성된 사용자 정보 반환

#### 2. 로그인 처리 흐름 (POST /users/login)
1. 클라이언트에서 이메일, 비밀번호 전송
2. `validateLogin` 미들웨어에서 기본 검증
3. `MySQLDatabaseService.getUserByEmail`로 사용자 조회
4. 사용자 존재 및 비밀번호 일치 확인
5. `jwtUtil.generateTokenPair`로 JWT 토큰 쌍 생성
6. `MySQLDatabaseService.createToken`으로 토큰 화이트리스트에 저장
7. 마지막 로그인 시간 업데이트
8. 200 상태 코드와 함께 토큰들 반환

#### 3. 토큰 갱신 처리 흐름 (POST /users/refresh)
1. 클라이언트에서 Refresh Token 전송
2. `MySQLDatabaseService.findActiveRefreshToken`으로 토큰 유효성 확인
3. `jwtUtil.refreshAccessToken`으로 새 토큰 쌍 생성
4. 기존 토큰 무효화 및 새 토큰 저장
5. 200 상태 코드와 함께 새 토큰들 반환

#### 4. 사용자 정보 조회 처리 흐름 (GET /users/me)
1. 클라이언트에서 Authorization 헤더에 Bearer Token 전송
2. `authenticateToken` 미들웨어에서 토큰 검증
   - JWT 서명 검증
   - 화이트리스트 확인 (DB 조회)
3. 검증 성공 시 사용자 정보를 request 객체에 추가
4. `MySQLDatabaseService.getUserById`로 최신 사용자 정보 조회
5. 200 상태 코드와 함께 사용자 정보 반환

#### 5. 프로필 수정 처리 흐름 (PUT /users/profile)
1. 클라이언트에서 Access Token과 수정할 데이터 전송
2. `authenticateToken` 미들웨어에서 인증 확인
3. `validateUserUpdate` 미들웨어에서 데이터 검증
4. `MySQLDatabaseService.updateUser`로 사용자 정보 업데이트
5. 200 상태 코드와 함께 수정된 사용자 정보 반환

#### 6. 로그아웃 처리 흐름 (POST /users/logout)
1. 클라이언트에서 Access Token 전송
2. `authenticateToken` 미들웨어에서 인증 확인
3. `MySQLDatabaseService.invalidateToken`으로 현재 토큰 무효화
4. 200 상태 코드와 함께 로그아웃 완료 메시지 반환

#### 7. 계정 삭제 처리 흐름 (DELETE /users/account)
1. 클라이언트에서 Access Token 전송
2. `authenticateToken` 미들웨어에서 인증 확인
3. `MySQLDatabaseService.deleteUser`로 사용자 계정 삭제
4. CASCADE 설정으로 관련 토큰 데이터도 자동 삭제
5. 200 상태 코드와 함께 계정 삭제 완료 메시지 반환

## 추가 정보

### 에러 코드 체계
- **ERR1000**: 필수 필드 누락 (400)
- **ERR1001**: 이메일 형식 오류 (400)
- **ERR1002**: 비밀번호 길이 부족 (400)
- **ERR1003**: 비밀번호 강도 부족 (400)
- **ERR1004**: 이름 길이 오류 (400)
- **ERR1005**: 이메일 중복 (409)
- **ERR1006**: 사용자를 찾을 수 없음 (404)
- **ERR1007**: 비밀번호 불일치 (401)
- **ERR1008**: 토큰 오류 (401)
- **ERR1009**: 권한 없음 (403)
- **ERR2001**: 사용자 정보 업데이트 실패 (500)
- **ERR2002**: 사용자 삭제 실패 (500)

### 보안 고려사항
1. **토큰 만료 시간**: Access Token 1시간, Refresh Token 5시간
2. **토큰 화이트리스트**: DB에 저장된 토큰만 유효로 인정
3. **자동 토큰 정리**: 6시간마다 만료된 토큰 자동 삭제
4. **비밀번호 보안**: bcrypt 해시 알고리즘 사용
5. **CASCADE 삭제**: 사용자 삭제 시 관련 토큰 자동 삭제

### 성능 최적화
1. **인덱스 활용**: 이메일, 토큰, 사용자 ID에 인덱스 설정
2. **토큰 조회 최적화**: isActive 필드를 통한 효율적인 쿼리
3. **비밀번호 검증**: 해시 비교를 통한 안전한 인증

### API 엔드포인트 요약
- `POST /users/signup`: 사용자 회원가입
- `POST /users/login`: 사용자 로그인
- `POST /users/refresh`: 토큰 갱신
- `GET /users/me`: 현재 사용자 정보 조회
- `PUT /users/profile`: 사용자 프로필 수정
- `POST /users/logout`: 사용자 로그아웃
- `DELETE /users/account`: 사용자 계정 삭제

### 의존성 관계
- **Express.js**: 웹 프레임워크
- **TypeORM**: 데이터베이스 ORM
- **MySQL**: 관계형 데이터베이스
- **JWT**: 토큰 기반 인증
- **bcrypt**: 비밀번호 암호화
- **crypto**: 추가 암호화 유틸리티